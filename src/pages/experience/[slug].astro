---
import ExperienceLayout from "../../layouts/ExperienceLayout.astro";
import { getCollection } from "astro:content";
import createSlug from "../../lib/createSlug";
import { filterDrafts } from "../../lib/content-config";
import HorizontalCard from "../../components/HorizontalCard.astro";

export async function getStaticPaths() {
  const allExperiences = await getCollection("experience");
  const experiences = filterDrafts(allExperiences);
  return experiences.map((experience) => ({
    params: { slug: createSlug(experience.data.title, experience.slug) },
    props: { experience },
  }));
}

const { experience } = Astro.props;
const { Content } = await experience.render();

// Extract the first bullet list from the markdown body
const extractFirstBullets = (markdown) => {
  const lines = markdown.split('\n');
  let bullets = [];
  let inList = false;
  for (const line of lines) {
    if (/^\s*[-*] /.test(line)) {
      if (!inList) inList = true;
      bullets.push(line.replace(/^\s*[-*] /, ''));
    } else if (inList && line.trim() === '') {
      break;
    } else if (inList) {
      break;
    }
  }
  return bullets;
};
const markdown = experience.body || '';
const bullets = extractFirstBullets(markdown);

// Related projects by matching badge
const allProjects = await getCollection("projects");
const relatedProjects = filterDrafts(allProjects)
  .filter(p => experience.data.badge && p.data.badge === experience.data.badge)
  .sort((a,b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<ExperienceLayout
  title={experience.data.title}
  company={experience.data.company}
  location={experience.data.location}
  startDate={experience.data.startDate}
  endDate={experience.data.endDate}
  image={experience.data.image}
>
  <!-- {bullets.length > 0 && (
    <ul class="list-disc ml-4 mb-4">
      {bullets.map(bullet => (
        <li set:html={bullet}></li>
      ))}
    </ul>
  )} -->
  <Content />
  {relatedProjects.length > 0 && (
    <div class="mt-12">
      <h2 class="text-2xl font-bold mb-4">Related Projects</h2>
      <div class="flex flex-col gap-4">
        {relatedProjects.map(project => (
          <HorizontalCard
            title={project.data.title}
            img={project.data.heroImage}
            desc={project.data.description}
            url={`/projects/${project.slug}/`}
            badge={project.data.badge}
            tags={project.data.tags}
          />
        ))}
      </div>
    </div>
  )}
</ExperienceLayout>
